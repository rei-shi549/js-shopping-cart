<!DOCTYPE html>
<html lang="ja">
<meta charset=utf-8>

<body>

<h3>商品一覧</h3>

<div id="items">

<div class="item" data-id="apple">
<img src="apple.jpg" width=120 height=90>
<div>&yen;<span class="price">100</span><span class="pieces"></span></div>
<form>数量<input type="number" style="width:2em;" class="kazu" min="1" value="1"></form>
<button type="button">add Cart</button>
</div>

<div class="item" data-id="orange">
<img src="orange.jpg" width=120 height=90>
<div>&yen;<span class="price">200</span><span class="pieces"></span></div>
<form>数量<input type="number" style="width:2em;" class="kazu" min="1" value="1"></form>
<button type="button">add Cart</button>
</div>

<div class="item" data-id="grape">
<img src="grape.jpg" width=120 height=90>
<div>&yen;<span class="price">100</span><span class="pieces"></span></div>
<form>数量<input type="number" style="width:2em;" class="kazu" min="1" value="1"></form>
<button type="button">add Cart</button>
</div>

</div>

<h3>カート　総合計：<span id="total">0</span></h3>
<div id="cart"></div>

<style>
#items, #cart{ border:1px solid #ccc; margin:1em; overflow:hidden;}
.item{ float:left; padding:5px; margin:1em; border:1px solid #ccc; width:120px; text-align:center; }
</style>

<script src="jQuery.js"></script>
<script src="https://code.jquery.com/ui/1.14.1/jquery-ui.js"></script>

<script>
//合計金額を計算、出力する関数
function updateTotal() {
	var sum = 0;									//合計金額計算用変数
	$("#cart .item").each(function() {
		price = $(this).children("div").children(".price").text() * 1; 		//カート内から単価を取得
		quantityText = $(this).children("div").children(".pieces").text();	//テキスト内の"×数量"を取得
		quantityParts = quantityText.replace("×", "");				//split()で"×"で切り分け、""と"数量"の配列化
		quantity =  quantityParts *1;// 					//カート内から数量を取得
		sum += price * quantity; 						//合計に加算
	});
	$("#total").text("￥" + sum.toLocaleString()); // 合計金額を更新
}

$(function(){
	$(".item button").click(function(){
		parentInput = $(this).parent();
		amount = parentInput.find("input.kazu").val() *1;
		if (amount <= 0 || isNaN(amount)) {
			alert("数量は1以上の数値を入力してください");
			return;
		}

		// 商品画像のsrcを取得（商品識別に使用する）
		fname = parentInput.find("img").attr("src");
		itemId = parentInput.attr("data-id");

		// カート内に同じ商品があるかチェック
		check = false;
		$("#cart .item").each(function(){
			cartImg = $(this).find("img").attr("src");
			if(cartImg == fname){
				// すでにある商品の数量を取得して加算
				piecesText = $(this).find(".pieces").text();
				temp = piecesText.replace("×", "") * 1;
				var currentAmount;
				if (isNaN(temp)) {
					currentAmount = 0;
				} else {
					currentAmount = temp;
				}
				newAmount = currentAmount + amount;
				$(this).find(".pieces").text("×" + newAmount);
				$(this).effect("bounce");
				check = true;
			}
		});

		// カート内に同じ商品がなければ新しく追加
		if(!check){
			c = parentInput.clone();
			c.find("form").remove();
			c.find(".pieces").text("×" + amount);
			c.find("button").text("remove Cart");
			c.find("button").on("click", function(){
				$(this).parent().effect("puff", function(){
					$(this).remove();
					updateTotal();
				});
			});
			c.attr("data-id", itemId);
			$("#cart").append(c);
			c.effect("bounce");
		}
	updateTotal();
	});
});
</script>

</body>

</html>